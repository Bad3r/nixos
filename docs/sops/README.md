# sops-nix Usage in This Repository

This repository manages secrets with [sops](https://github.com/mozilla/sops) and [sops-nix](https://github.com/Mic92/sops-nix). The policy is intentionally small: one editor key, one host key, and a handful of templates that expose runtime files only when encrypted material exists.

## What Ships in the Repo

- `.sops.yaml` is generated by `modules/security/sops-policy.nix` through the `files` module. The canonical policy currently contains:
  - `owner_bad3r` (Age public key) – the maintainer who edits secrets.
  - `host_primary` (Age public key) – the System76 laptop that decrypts secrets at activation time.
  - Three rules: the general catch-all, `secrets/act.yaml`, and `secrets/r2.env` (encrypted entirely).
- `modules/security/secrets.nix` imports `inputs.sops-nix.nixosModules.sops`, exposes `age`/`sops` in `environment.systemPackages`, and points `sops.age.keyFile` to `/var/lib/sops-nix/key.txt`.
- Secret declarations are guarded with `builtins.pathExists`. If `secrets/act.yaml` is missing the entire block is skipped, keeping evaluation pure.
- Templates write to stable paths (`/etc/act/secrets.env`) and inherit ownership from `config.flake.lib.meta.owner.username`.

## Host Preparation

1. Generate the Age host key once per machine:
   ```bash
   sudo install -d -m 0700 -o root -g root /var/lib/sops-nix
   sudo age-keygen -o /var/lib/sops-nix/key.txt
   sudo chmod 0600 /var/lib/sops-nix/key.txt
   sudo age-keygen -y /var/lib/sops-nix/key.txt   # prints the public key for rotation
   ```
2. Add the public key to `modules/security/sops-policy.nix` (it will replicate to `.sops.yaml` on the next `write-files`).
3. Keep a secure offline copy of `/var/lib/sops-nix/key.txt`.

### Home Manager user service

The Home Manager side now runs `sops-nix.service` with an isolated home directory at
`~/.local/share/sops-nix`. Make sure `~/.config/sops/age/keys.txt` contains the user Age
identity (matching the `owner_bad3r` recipient). Because the service never sees `~/.ssh/`,
hardware-backed SSH keys can coexist without breaking SOPS.

## Adding a New Secret

1. Confirm the recipient exists in `.sops.yaml` (regenerate via `nix develop -c write-files` if you just edited the policy module).
2. Create or edit the encrypted file:
   ```bash
   sops secrets/<name>.yaml
   ```
3. Declare the secret in a module:
   ```nix
   sops.secrets."<namespace>/<name>" = {
     sopsFile = ./../../secrets/<name>.yaml;
     mode = "0400";
     owner = config.flake.lib.meta.owner.username;
   };
   ```
4. Reference the runtime material via `.path` or a template. Never read secrets at evaluation time.
5. Run the validation suite (see [`docs/architecture/06-reference.md`](../architecture/06-reference.md#validation)).

## Example: GitHub Token for `act`

- Encrypted file: `secrets/act.yaml` with field `github_token`.
- Declaration lives in `modules/security/secrets.nix` (`sops.secrets."act/github_token"`).
- Template renders `/etc/act/secrets.env` and the dev-shell helper `gh-actions-run` automatically picks it up unless `ACT_SECRETS_FILE` overrides the path.
- Rotate with `sops secrets/act.yaml`, build via `nix build .#nixosConfigurations.system76.config.system.build.toplevel`, and deploy with `./build.sh --host system76 --boot` (or the approved helper for your host).

## Working With `r2.env`

The Home Manager module `modules/home/r2-user.nix` reads `sops.templates."r2"` (populated when `secrets/r2.env` exists). Follow the same pattern as above; the shell helper prints actionable errors if the template is missing.

## Editing Encrypted Files Safely

### Interactive Editing

For simple edits, use `sops` directly—it handles decryption, opens your editor, and re-encrypts on save:

```bash
sops secrets/<name>.yaml
```

### Programmatic / Scripted Editing

When modifying secrets programmatically (e.g., appending rules, updating values via scripts), follow this procedure to avoid data loss:

```bash
# 1. Decrypt to a TEMPORARY file (never redirect over the original)
sops -d secrets/<name>.yaml > /tmp/plaintext.yaml

# 2. Modify the temporary file
# ... your edits here ...

# 3. Write the modified content to the TARGET path (overwrite is safe now)
cp /tmp/plaintext.yaml secrets/<name>.yaml

# 4. Encrypt IN-PLACE with -i flag
sops -e -i secrets/<name>.yaml

# 5. Clean up plaintext
rm /tmp/plaintext.yaml
```

**Critical warnings:**

| Anti-pattern                                     | Why it fails                                                                                                                     |
| ------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------- |
| `sops -e /tmp/file.yaml > secrets/original.yaml` | Shell truncates `original.yaml` to 0 bytes _before_ sops runs. If sops fails, the original is gone.                              |
| `sops -e secrets/file.tmp > secrets/file.yaml`   | Files with non-matching extensions (`.tmp`) don't match `.sops.yaml` creation rules, causing `no matching creation rules found`. |
| `sops -d secrets/file.yaml > secrets/file.yaml`  | Same truncation issue—output redirect destroys input before read.                                                                |

**Safe one-liner pattern:**

```bash
sops -d secrets/<name>.yaml > /tmp/plain.yaml && \
  # modify /tmp/plain.yaml as needed, then:
  cp /tmp/plain.yaml secrets/<name>.yaml && \
  sops -e -i secrets/<name>.yaml && \
  rm /tmp/plain.yaml
```

The key insight: always use `sops -e -i` (in-place) for the final encryption step, never shell redirects.

## Quick Checklist

- [ ] `write-files` run after changing `modules/security/sops-policy.nix`.
- [ ] Encrypted file committed under `secrets/` (plaintext never checked in).
- [ ] Secret declared with explicit `mode`, `owner`, and (when needed) `group`.
- [ ] Consumers use `.path` or template outputs only.
- [ ] Validation suite passes.

## Common Issues

| Symptom                               | Fix                                                                                                                                                                                     |
| ------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `no secret material for ...`          | Check that the encrypted file exists. Declarations are guarded with `pathExists`.                                                                                                       |
| `Unknown recipient` while editing     | Regenerate `.sops.yaml` (`nix develop -c write-files`) or add the key to `modules/security/sops-policy.nix`.                                                                            |
| `Permission denied` reading secret    | Adjust the `owner`/`group` fields in the module; sops-nix enforces them strictly.                                                                                                       |
| `act` complaining about missing token | Ensure `/etc/act/secrets.env` exists (rerun `./build.sh --host <host> --boot` or the approved deployment helper after updating secrets).                                                |
| `no matching creation rules found`    | The file path doesn't match any regex in `.sops.yaml`. Ensure the file is under `secrets/` with a valid extension (`.yaml`, `.json`, `.env`, etc.). Temp files like `.tmp` won't match. |
| `sops metadata not found`             | The file is plaintext or corrupted. Re-encrypt with `sops -e -i <file>` if plaintext, or restore from backup if corrupted.                                                              |
| File truncated to 0 bytes             | Shell redirect (`>`) truncated before command ran. Restore from backup and use `sops -e -i` (in-place) instead of redirects.                                                            |

## Validation Commands

See [`docs/architecture/06-reference.md`](../architecture/06-reference.md#validation) for the canonical validation suite. These checks ensure sops policy is regenerated, secrets stay encrypted, and managed files stay in sync.
