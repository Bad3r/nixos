# sops-nix Usage in This Repository

This repository manages secrets with [sops](https://github.com/mozilla/sops) and [sops-nix](https://github.com/Mic92/sops-nix). The policy is intentionally small: one editor key, one host key, and a handful of templates that expose runtime files only when encrypted material exists.

## What Ships in the Repo

- `.sops.yaml` is generated by `modules/security/sops-policy.nix` through the `files` module. The canonical policy currently contains:
  - `owner_bad3r` (Age public key) – the maintainer who edits secrets.
  - `host_primary` (Age public key) – the System76 laptop that decrypts secrets at activation time.
  - Three rules: the general catch-all, `secrets/act.yaml`, and `secrets/r2.env` (encrypted entirely).
- `modules/security/secrets.nix` imports `inputs.sops-nix.nixosModules.sops`, exposes `age`/`sops` in `environment.systemPackages`, and points `sops.age.keyFile` to `/var/lib/sops-nix/key.txt`.
- Secret declarations are guarded with `builtins.pathExists`. If `secrets/act.yaml` is missing the entire block is skipped, keeping evaluation pure.
- Templates write to stable paths (`/etc/act/secrets.env`) and inherit ownership from `config.flake.lib.meta.owner.username`.

## Host Preparation

1. Generate the Age host key once per machine:
   ```bash
   sudo install -d -m 0700 -o root -g root /var/lib/sops-nix
   sudo age-keygen -o /var/lib/sops-nix/key.txt
   sudo chmod 0600 /var/lib/sops-nix/key.txt
   sudo age-keygen -y /var/lib/sops-nix/key.txt   # prints the public key for rotation
   ```
2. Add the public key to `modules/security/sops-policy.nix` (it will replicate to `.sops.yaml` on the next `write-files`).
3. Keep a secure offline copy of `/var/lib/sops-nix/key.txt`.

### Home Manager user service

The Home Manager side now runs `sops-nix.service` with an isolated home directory at
`~/.local/share/sops-nix`. Make sure `~/.config/sops/age/keys.txt` contains the user Age
identity (matching the `owner_bad3r` recipient). Because the service never sees `~/.ssh/`,
hardware-backed SSH keys can coexist without breaking SOPS.

## Adding a New Secret

1. Confirm the recipient exists in `.sops.yaml` (regenerate via `nix develop -c write-files` if you just edited the policy module).
2. Create or edit the encrypted file:
   ```bash
   sops secrets/<name>.yaml
   ```
3. Declare the secret in a module:
   ```nix
   sops.secrets."<namespace>/<name>" = {
     sopsFile = ./../../secrets/<name>.yaml;
     mode = "0400";
     owner = config.flake.lib.meta.owner.username;
   };
   ```
4. Reference the runtime material via `.path` or a template. Never read secrets at evaluation time.
5. Run the validation suite (`nix fmt`, `nix develop -c pre-commit run --all-files`, `generation-manager score`, `nix flake check --accept-flake-config`).

## Example: GitHub Token for `act`

- Encrypted file: `secrets/act.yaml` with field `github_token`.
- Declaration lives in `modules/security/secrets.nix` (`sops.secrets."act/github_token"`).
- Template renders `/etc/act/secrets.env` and the dev-shell helper `gh-actions-run` automatically picks it up unless `ACT_SECRETS_FILE` overrides the path.
- Rotate with `sops secrets/act.yaml` and re-run `nixos-rebuild switch --flake .#system76` on the host.

## Working With `r2.env`

The Home Manager module `modules/home/r2-user.nix` reads `sops.templates."r2"` (populated when `secrets/r2.env` exists). Follow the same pattern as above; the shell helper prints actionable errors if the template is missing.

## Quick Checklist

- [ ] `write-files` run after changing `modules/security/sops-policy.nix`.
- [ ] Encrypted file committed under `secrets/` (plaintext never checked in).
- [ ] Secret declared with explicit `mode`, `owner`, and (when needed) `group`.
- [ ] Consumers use `.path` or template outputs only.
- [ ] Validation suite passes.

## Common Issues

| Symptom                               | Fix                                                                                                          |
| ------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| `no secret material for …`            | Check that the encrypted file exists. Declarations are guarded with `pathExists`.                            |
| `Unknown recipient` while editing     | Regenerate `.sops.yaml` (`nix develop -c write-files`) or add the key to `modules/security/sops-policy.nix`. |
| `Permission denied` reading secret    | Adjust the `owner`/`group` fields in the module; sops-nix enforces them strictly.                            |
| `act` complaining about missing token | Ensure `/etc/act/secrets.env` exists (run `sudo nixos-rebuild switch` after editing secrets).                |

## Validation Commands

```bash
nix fmt
nix develop -c pre-commit run --all-files
generation-manager score
nix flake check --accept-flake-config
```

These checks ensure sops policy is regenerated, secrets stay encrypted, and managed files stay in sync.
