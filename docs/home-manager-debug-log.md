# Home Manager Config Debug Log

- 2025-10-19 (trace run #1) `nix --accept-flake-config eval .#nixosConfigurations.system76.config."home-manager"`
  - Output only contained `extraAppImports`.
  - Confirms regression relative to expected attrset.
- Added temporary `builtins.trace` in `modules/home-manager/nixos.nix` to verify module execution.
  - Trace fired, showing `hm-base config (hm input present)`.
  - Indicates the base module runs and sees the Home Manager input.
- Evaluated `options.home-manager` with `--show-trace`.
  - Only option exposed is `home-manager.extraAppImports`.
  - Suggests upstream Home Manager module is not being imported into the System76 configuration.
- Inspected module aggregation: `modules/roles/base.nix` imports `flake.nixosModules.base`, and `modules/workstation.nix` adds that role via `baseImport`. Therefore the Home Manager integration _is_ part of the System76 stack; the missing fields stem from a later override rather than the base bundle never loading.
  - Next step: trace where `config.home-manager` gets replaced after the base merge—likely by a module assigning `home-manager = { extraAppImports = …; }` instead of using `lib.mkMerge`/`mkAfter`.
- Added a `builtins.trace` wrapper around `config.home-manager` in `modules/home-manager/nixos.nix`; during evaluation it reports the base module assigning keys `backupFileExtension`, `extraSpecialArgs`, `useGlobalPkgs`, and `users`.
  - Despite that, the final merged `config.home-manager` still renders with only `extraAppImports`, confirming a later definition is overwriting (not merging) the attrset.
  - Next step: hunt for modules that set `config.home-manager = …` or otherwise replace the attrset (e.g., via `lib.mkForce`) rather than merging nested attributes.
- Traversed `nixosConfigurations.system76._module.args.modules` and the nested import graph: the upstream Home Manager module is included (wrapped inside the base aggregator), and only the base module contributes keys under `config.home-manager`.
  - Option introspection shows `home-manager.extraAppImports` receives three definitions, all from the System76 host modules (`modules/system76/imports.nix`, `modules/system76/virtualization.nix`, `modules/system76/home-manager-apps.nix`).
  - Current hypothesis: one of those host-level modules replaces `config.home-manager` wholesale, leaving only `extraAppImports` in the final view.
  - Next step: reuse the real `_module.args` with `lib.evalModules` so we can inspect the merged `config.home-manager` after each host module is applied.
- 2025-10-20 (trace run #2) sanity-check on module wiring.
  - `rg` sweep shows `modules/home-manager/nixos.nix` is the only place assigning `config.home-manager = { … }`, so the missing attrset is due to the module never being imported rather than a later override.
  - Confirmed via `modules/system76/imports.nix` that the host expects to pick up `flake.nixosModules.base` indirectly through the workstation bundle; the host layer itself does not import base directly.
  - Reviewed `modules/workstation.nix`: `baseImport` should resolve the base role and pull in the module that provides the Home Manager glue, but we have not yet verified that the role resolution actually succeeds for System76.
  - Attempted to print `nixosConfigurations.system76._module.args.modules` (`nix eval --accept-flake-config --impure …`) and only saw `<lambda>`/`<unknown>` placeholders, so we still need better instrumentation (e.g., `lib.debug.traceValSeq`) to confirm whether the base module lands in the import stack.
  - Next step: instrument workstation assembly (or reuse `_module.args`) to ensure the base role contributes the Home Manager module before continuing with further hypotheses.
- Instrumented `modules/workstation.nix` with `builtins.trace` to log the resolved module lists; `baseImport` returns a single attrset (the base role), so the workstation bundle _is_ pulling a role wrapper—we still need to verify that role actually imports the Home Manager glue downstream.
- Added tracing in `modules/roles/base.nix`; the base role resolves to `/flake.nix#nixosModules.base` plus a long list of app modules, so the role itself is constructed correctly.
- Initially checked `hasHM = builtins.any (m: m._file == ".../modules/home-manager/nixos.nix") flake.outputs.nixosModules.base.imports` and got `false`, but that equality test compared against the working-tree path instead of the store path the aggregator emits, so the result was a false negative.
- Drilled into `flake.outputs.nixosModules.base` directly: index `30` corresponds to the module synthesized from `modules/home-manager/nixos.nix`. That synthesized module does carry `imports = [ /nix/store/.../nixos ]`, yet when we query `nixosConfigurations.system76.options.home-manager`, the only defined option is still `extraAppImports`. Conclusion: `inputs.home-manager.nixosModules.home-manager` is present in the import graph but apparently not evaluating (or its options are not surfacing), so the next step is to inspect the import-tree glue to understand how it rewrites module contributions and why the upstream Home Manager options/config never make it to the host.
- Confirmed that the generated module for `modules/home-manager/nixos.nix` still exposes the expected config keys (`backupFileExtension`, `extraSpecialArgs`, `useGlobalPkgs`, `users`) and imports the upstream Home Manager module; however, enumerating `nixosConfigurations.system76.config.home-manager` via `nix eval --json` continues to show only `extraAppImports`, which means something later in the host stack either drops or never merges those keys.
- Dumped `nixosConfigurations.system76._module.args.modules` to hunt for a later overwrite; the list mainly contains anonymous functions and nothing with a visible `config.home-manager`, suggesting the base Home Manager glue might never reach the host evaluation despite being present in the aggregated `flake.nixosModules.base` imports. Need to trace how the import-tree generated workstation/base modules end up in `_module.args.modules` to confirm whether the glue module is skipped entirely or stripped when converted to callable modules.
- New finding: `modules/security/secrets.nix` set `_module.args = { };` (no merge helper). Inspecting the evaluated host with `nix eval --accept-flake-config '.#nixosConfigurations.system76._module.args' --apply builtins.attrNames` showed the resulting attrset lacked `inputs`/`self`, so the Home Manager glue fell back to `{}` for `moduleArgs.inputs`. Hypothesis confirmed: secrets module ran after the glue and wiped `_module.args`, stripping helper arguments for everything downstream. **Action:** removed that assignment entirely so helper args flow through. After removal the host still reports only `home-manager.extraAppImports`, which confirms the wipe was part of the problem but not the whole story; next step is to decode how `nixosConfigurations.system76._module.args.modules` expands (currently `[<function>, attrset-with-21 imports, <function>]`) and where the base glue is supposed to be injected so we can reintroduce the Home Manager defaults.
- Tried re-introducing `(getModule "base")` into `modules/system76/imports.nix` so the host would explicitly import the base bundle. Running `nix flake check --accept-flake-config` failed with `Home Manager base module: expected flake.homeManagerModules.base to be available.` Root cause: pulling the base module directly from the host bypasses the workstation/role pipeline that populates `flake.homeManagerModules.*`; when the base module runs this early, the aggregator hasn’t registered `flake.homeManagerModules.base` yet, so the glue throws. Reverted the change and noted that the base bundle is supposed to arrive via the workstation profile instead.
