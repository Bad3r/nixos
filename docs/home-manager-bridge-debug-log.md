# Home Manager Bridge Debug Log (Living Document)

**Status:** Investigation in progress
**Last Updated:** 2025-10-19

This document captures everything we have learned so far while debugging the Home Manager bridge regression introduced during the RFC-0001 role taxonomy work. It is intentionally concise and will be updated as new hypotheses are tested.

---

## 1. Problem Statement

Home Manager modules exported under `flake.homeManagerModules.*` fail to reach host configurations (for example `system76`). Evaluations such as:

```bash
nix --accept-flake-config eval .#nixosConfigurations.system76.config."home-manager".users.vx
```

throw because the `home-manager.users` subtree never materialises, even though the role graph is expected to wire it via `_module.args.homeManagerModules`.

---

## 2. Hypotheses Tested

| #   | Hypothesis                                                                                                                                                                  | Actions Taken                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Outcome                                                                                                                                                                                                                                             | Learning                                                                                                                                                                                                                                                   |
| --- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | **`config.flake` was empty when the host imports ran**, so the workstation bundle (and with it the HM bridge) never reached `system76`.                                     | Added traces around `modules/system76/imports.nix` to confirm whether `getModule "workstation"` was returning `null`.                                                                                                                                                                                                                                                                                                                                                                                           | Trace output showed “system76: workstation module found”; `config.flake.nixosModules.workstation` _is_ present during host composition.                                                                                                             | The workstation bundle is available; the drop happens later in the pipeline.                                                                                                                                                                               |
| 2   | **`modules/meta/flake-output.nix` rejected free-form `flake.*` keys**, causing any `flake.nixosModules.*` / `flake.homeManagerModules.*` definitions to be discarded early. | Attempted to widen the option type to accept arbitrary attributes. The module collided with `flake-parts`’ own `flake` option and produced duplicate-option errors.                                                                                                                                                                                                                                                                                                                                             | Rollback restored original behaviour; `flake-parts` already provides a free-form `flake` attr set.                                                                                                                                                  | The configuration framework is not silently dropping `flake.*` assignments; the issue lies elsewhere.                                                                                                                                                      |
| 3   | **The Home Manager module never contributed `home-manager.users`** because owner metadata was missing during evaluation.                                                    | Inspected the imported module tree by traversing `flake.nixosModules.base`. Confirmed that the generated module from `modules/home-manager/nixos.nix` contains `home-manager.users.vx` plus the expected defaults.                                                                                                                                                                                                                                                                                              | `home-manager.users.vx` exists inside the role bundle prior to host evaluation.                                                                                                                                                                     | The subtree is being removed or overshadowed after the module graph is flattened/merged. The failure is not caused by missing owner metadata.                                                                                                              |
| 4   | **Overriding the HM bridge at the host layer could restore functionality.**                                                                                                 | Experimented locally (abandoned quickly) with manual imports and option overrides; recognised risk of duplication and Stylix conflicts.                                                                                                                                                                                                                                                                                                                                                                         | Not pursued beyond initial check—risk of compounding the bug outweighed potential benefit.                                                                                                                                                          | Fix must happen upstream (role helper / bridge logic). Host-level hacks are discouraged.                                                                                                                                                                   |
| 5   | **App/role helper sanitisation removes the embedded Home Manager exports (`flake.homeManagerModules.*`)** so the bridge never receives them.                                | Compared helper sanitisation in `modules/meta/nixos-app-helpers.nix` and `modules/meta/nixos-role-helpers.nix` against app modules like `modules/apps/lutris.nix` that bundle a `flake.homeManagerModules` subtree. Patched both helpers to stop stripping `flake` and to treat string/path modules as passthroughs.                                                                                                                                                                                            | After the change, `nix eval --impure --accept-flake-config '.#nixosConfigurations.system76.config."home-manager".useGlobalPkgs'` now succeeds (returns `true` instead of a missing-attribute error), proving the bridge survived helper flattening. | Sanitisation was part of the regression, but restoring the `flake` attribute did **not** repopulate `home-manager.users`; another stage still drops `flake.homeManagerModules.base`.                                                                       |
| 6   | **The Home Manager app registry still arrives as the raw `flake.homeManagerModules` tree, so modules receive attrsets with `imports` instead of concrete HM modules.**      | Instrumented `modules/home-manager/nixos.nix` after wiring `_module.args.inputs.self` through `flake.nix`; traces show `hmModules.base` resolves to a set whose `imports` chain still contains attrsets (`keys=imports`, `secondImportKeys=<lambda>`). Evaluating `nix eval --impure --accept-flake-config '.#nixosConfigurations.system76.config."home-manager".users.vx.home.stateVersion'` now fails with `The option home-manager.users.vx.apps does not exist`, listing every app attrset as a definition. | Positive: the bridge now sees the full registry (`hmModulesFromConfig=[apps, base, …]`). Negative: the module system interprets those attrsets as option definitions instead of modules, leading to the new failure.                                | We must add a dedicated `home-manager` helper that sanitises the registry (strip `_file` metadata, recursively flatten `imports`, extract the final module lambdas) before handing them to `modules/home-manager/nixos.nix` and `modules/workstation.nix`. |

---

## 3. Current Understanding

1. The workstation role does reach the host, and the Home Manager bundle exists inside that role _before_ sanitisation/flattening concludes.
2. Helper sanitisation no longer strips `flake.*`, yet `nix eval --impure --accept-flake-config '.#nixosConfigurations.system76.config."home-manager".users.vx.home.stateVersion'` still fails with `Home Manager base module: expected flake.homeManagerModules.base to be available.` Traces added in `modules/home-manager/nixos.nix` show `moduleArgs.inputs.self` is missing during evaluation, so `_module.args` never receives a populated `homeManagerModules` map.
3. No evidence so far that the bridge failure originates in host wiring, owner metadata, or `flake.*` option hygiene; the gap appears when the Home Manager base module tries to pull the aggregator from `_module.args.inputs.self`.

---

## 4. Open Questions / Next Lines of Inquiry

- Pinpoint where `flake.homeManagerModules` is supposed to populate `_module.args.homeManagerModules` during evaluation, and ensure that stage still runs in the current flake-parts wiring.
- Determine whether another module later in the merge chain overwrites `config.home-manager` wholesale.
- Add targeted instrumentation or assertions to fail fast when `home-manager.users` evaporates during evaluation.
- Ensure `_module.args` gets a populated `homeManagerModules` attribute before `modules/home-manager/nixos.nix` runs (potentially by explicitly wiring `inputs.self.homeManagerModules` into `_module.args` at a meta layer).

---

## 5. Update Procedure

1. When a new hypothesis is tested, add a new row to the table in §2 with the actions, outcome, and learning.
2. Update §3 and §4 to reflect any shifts in understanding or outstanding work.
3. Bump the **Last Updated** date at the top of the document.

---

_Maintainer note:_ keep this log close to the facts from reproducible evaluations (`nix eval`, scratchpads) so it remains a reliable reference as RFC-0001 stabilises.
