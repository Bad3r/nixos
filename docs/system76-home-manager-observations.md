# System76 Home Manager Integration – Current Findings

## Summary

System76’s NixOS host does import the workstation bundle and the System76‑specific overlays, but the Home Manager glue never succeeds. As a result the evaluated configuration only exposes the `home-manager.extraAppImports` knob, and no Home Manager users or defaults are generated.

## Key Observations

- `nix eval --accept-flake-config '.#nixosConfigurations.system76.config.home-manager'` returns an attrset with just `extraAppImports`, confirming the broader Home Manager config never materialises.
- Querying `config.home-manager.users` via
  `nix eval --accept-flake-config --impure --expr 'let flake = builtins.getFlake (toString ./.) ; in flake.nixosConfigurations.system76.config.home-manager.users'`
  fails with `attribute 'users' missing`; the owner import from `modules/home-manager/nixos.nix` never ran.
- The module args visible during host evaluation omit flake inputs:
  `nix eval --accept-flake-config '.#nixosConfigurations.system76._module.args' --apply builtins.attrNames`
  → `[ "baseModules" "extendModules" "extraModules" "moduleType" "modules" "noUserModules" "pkgs" "utils" ]`.
- `_module.specialArgs` confirms only the default `modulesPath` is passed through (`nix eval … '_module.specialArgs'`), so no `inputs`/`self` reach downstream modules.
- `modules/system76/imports.nix` builds `nixosConfigurations.system76` by calling `inputs.nixpkgs.lib.nixosSystem { modules = [ … config.configurations.nixos.system76.module ]; }` without any `specialArgs`. Because of that, the module system never seeds `_module.args.inputs`, and the Home Manager glue’s lookup of `flake.homeManagerModules.base` fails.
- Inspecting `flake.outputs.nixosModules.base` directly shows the Home Manager glue is already missing **before** the role helper runs: every entry— including `modules/home-manager/nixos.nix`—exposes only `_file` and `imports`, with no `flake.homeManagerModules` or `config.home-manager` payload. This confirms the loss happens upstream of the role sanitisation.
- The extended scaffold (`debug/system76-home-manager-scaffold.nix`) now seeds `_module.args.pkgs` plus stub namespaces so `lib.evalModules` can evaluate `flake.nixosModules.base` in isolation; every traced import under that bundle leaves `config.home-manager` with the full key set (`backupFileExtension`, `enableLegacyProfileManagement`, `overwriteBackup`, `useUserPackages`, `verbose`, …).
- Feeding the same scaffold the real System76 import graph shows the very first checkpoint—`pre-system76`, taken immediately after the flake-provided prelude—already trimmed to `backupFileExtension, extraAppImports, extraSpecialArgs, sharedModules, useGlobalPkgs, users`, and none of the deeper labels ever restore the missing keys. The collapse therefore precedes any System76 overlay module.
- Attempting to read `_module.args.inputs` from the live host still fails (`attribute 'inputs' missing`), confirming those helpers never reach the evaluation despite the scaffold supplying them manually.
- Option inspection confirms that, after the System76 overlays are applied, the module system no longer registers `options.home-manager.*` entries at all—the attrset collapses to whatever the overlays append, leaving the base definitions (e.g. `enableLegacyProfileManagement`, `overwriteBackup`, `useUserPackages`, `verbose`) absent from both `options` and `config`.
- Runtime probing (`lib.evalModules` with an inline helper) shows `_module.args.nixosRoleHelpers` is **absent** during the System76 evaluation, so `modules/workstation.nix` falls back to `config.flake.nixosModules.roles` when resolving `base`. The helper namespace (`config.flake.lib.nixos.roles`) still exposes `base`, which explains why the workstation stack continues to pull application modules while the dedicated role helpers—and their glue wiring—never run.
- A recursive sweep of `nixosConfigurations.system76._module.args.modules` finds no module originating from `modules/meta/nixos-role-helpers.nix` or `modules/meta/nixos-app-helpers.nix`; the base bundle still contains other meta contributors (docs, owner, nixpkgs-allowed-unfree), so the helper injection never enters the host evaluation, leaving both `_module.args.nixosRoleHelpers` and the `flake.lib.nixos` helper namespace unset.
- Adding `modules/meta/nixos-helpers.nix` to import the helper modules ensures `_module.args.nixosRoleHelpers` and `_module.args.nixosAppHelpers` appear in base-only evaluation, and `modules/meta/nixos-roles-import.nix` now pulls `modules/roles/**` into the base aggregator. After those changes `config.flake.nixosModules.roles` finally exposes the first role (`ai-agents`), proving the aggregator is active—but the remaining roles still fail to load because their prerequisites (apps, window-manager modules, etc.) aren’t satisfied during the scaffold run.
- Evaluating the full System76 stack still strips `_module.args` back to `{ extendModules, moduleType, pkgs }`; `config.home-manager` retains only `backupFileExtension`, `extraAppImports`, `extraSpecialArgs`, `sharedModules`, `useGlobalPkgs`, and `users`, so options like `enableLegacyProfileManagement`, `overwriteBackup`, `useUserPackages`, and `verbose` remain missing.
- 2025-10-21 — Normalised the System76 import stage to unwrap import-tree payloads before the workstation checks run. Introduced `flattenImportTree` inside `modules/system76/imports.nix` so lookups such as `getModule "base"` and the role resolver see plain attrsets rather than `_type`/`content` stubs. `nix flake check --accept-flake-config` still halts with `Home Manager base module: expected flake.homeManagerModules.base to be available.`, and `nix eval --accept-flake-config '.#nixosConfigurations.system76.config.flake.nixosModules'` continues to fail on `attribute 'lang' missing`, which shows the flattening step alone doesn’t surface the missing Home Manager glue.
- The `_module.args` trace continues to show that the collapse happens at the `pre-system76` checkpoint. Because only one role successfully registers, `modules/system76/imports.nix` still fails to resolve `base` and other workstation roles (the helper falls back to `config.flake.nixosModules.roles`, which lacks those keys), preventing the base bundle—and thus the Home Manager glue—from executing.
- Instrumenting the scaffold with `debug.roleProbe` now records every role module under `modules/roles`. Most files export a `flake.nixosModules.roles.<name>.imports` attrset and evaluate cleanly, while dotted roles (for example `roles.dev.clj`) land under nested paths that our probe flattens separately. Roles that fan out to language bundles (`dev-clj`, `dev-go`, `dev-py`, `dev-rs`) expect stubs under `flake.nixosModules.lang.*`, and desktop roles reach for `flake.nixosModules.window-manager.i3`. Until those namespaces are stubbed, the aggregator keeps collapsing to just `ai-agents`, so the helpers never expose additional role names to the workstation stack.
- Added a dedicated `stubModule` to the scaffold that pre-populates `flake.nixosModules.apps`, `flake.nixosModules.lang`, and `flake.nixosModules."window-manager"` with real modules when available and inert lambdas otherwise. This prevents `nixos-app-helpers` and the desktop roles from crashing on missing lookups, but the flattened attrset at `config.flake.nixosModules.roles` still comes back empty—confirming that the roles import itself isn’t materialising yet, even though each role module evaluates successfully in isolation.
- With `DEBUG_ROLES=1` instrumentation in `modules/meta/nixos-role-helpers.nix`, both the base-only harness and the full System76 evaluation show `flattenRoles` merging the complete key set (`ai-agents`, `base`, `chat`, `cli`, `cloudflare`, `desktop`, `dev`, `file-sharing`, `files`, `gaming`, `media`, `net`, `pentesting-devshell`, `productivity`, `security`, `warp-client`, `xserver`) and `availableRoles` exposing the same list. The helper attrset is therefore intact; the disappearance of `config.flake.nixosModules.roles` happens after the helper runs (or never receives the merged attrset), not because the flatten step discarded anything.
- The debug stub was the culprit: it previously assigned `config.flake.nixosModules` to a tiny attrset `{ apps, lang, "window-manager" }`, erasing the default `roles` subtree provided by `inputs.self.nixosModules`. Updating the stub to merge against `self.nixosModules` (`lib.mkDefault (selfModules // { ... })`) lets the native flake exports flow through. After the change, `debug.flakeFinal` shows the full namespace and `roles = [ "_file" "imports" ]`, matching the structure the helper already flattened.
- The System76 host definition also skipped `flake.nixosModules.base`, so the workstation bundle was layering its tweaks onto an empty Home Manager attrset. Adding `getModule "base"` to `modules/system76/imports.nix` ensures the host imports the base bundle before `workstation`. After that change, the full System76 evaluation (`sc.modules`) retains the default flags—`enableLegacyProfileManagement`, `overwriteBackup`, `useUserPackages`, `verbose`—and `config.home-manager` once again matches the base harness.
- Evaluating the base harness directly with `nix eval --accept-flake-config --impure --show-trace --expr 'let flake = builtins.getFlake (toString ./.); harness = import ./debug/system76-home-manager-scaffold.nix { inherit flake; lib = flake.inputs.nixpkgs.lib; }; lib = flake.inputs.nixpkgs.lib; in lib.evalModules { modules = harness.baseModulesForTrace; specialArgs = harness.specialArgs; }'` still aborts with `error: The option 'flake.nixosModules' does not exist. Definition values: - In '/nix/store/.../modules/roles/xserver.nix'`. This pinpoints the remaining ordering bug: role modules evaluate before any bootstrap path defines the `flake.*` option schema, so base-only evaluation never succeeds.
- Inspecting `flake.nixosModules.base.imports` shows the synthetic entry for `modules/meta/nixos-helpers.nix` expands to `{ imports = [ /…/nixos-roles-preload.nix /…/flake-output.nix /…/nixos-role-helpers.nix /…/nixos-app-helpers.nix ] }`. Because that list starts with `nixos-roles-preload.nix`, evaluation hits `config.flake.nixosModules = …` before `modules/meta/flake-output.nix` defines the `flake.*` option schema, so the first role that touches it (`roles/xserver.nix`) still throws.
- Reordering that helper list to run `flake-output.nix` first fixes the immediate ordering issue, but the base scaffold still fails: `lib.evalModules` continues to throw “option 'flake.nixosModules' does not exist” because the harness never loads the flake-parts bootstrap (`flake-parts/modules/nixosModules.nix`). Attempts to stub the option locally (`options.flake.nixosModules = …`) are ignored—the failure trace never shows the stub firing—so we must import the real bootstrap module (with its `mkSubmoduleOptions` wiring) before evaluating any role file.
- Added `debug/flake-nixosModules-reproducer.nix` to isolate the failure: evaluating a single module that writes `config.flake.nixosModules.roles.xserver` reproduces the missing-option error, while prepending a minimal stub module (`options.flake.nixosModules = …`) lets the same evaluation succeed. This confirms the harness simply needs the option defined before the roles run; the remaining work is ensuring the real bootstrap executes during System76 evaluation instead of relying on ad-hoc stubs.
- Reintroducing the manual `modules/meta/flake-output.nix` import inside `modules/meta/nixos-helpers.nix` remains necessary today. Without it, the meta aggregator (`nixos-roles-preload` → `nixos-role-helpers` → `nixos-app-helpers`) crashes immediately because no one has defined the `flake.*` option namespace yet. With the import restored, the evaluation makes it past the helpers and fails later in `modules/roles/xserver.nix`, indicating the bootstrap simply moves the symptom downstream rather than fixing the underlying requirement to seed `flake.*` before either stack runs.
- Reordering the helper list so `flake-output.nix` runs before `nixos-roles-preload.nix` removes that early assignment, but the base harness continues to fail: the structured trace still reports `error: The option 'flake.nixosModules' does not exist` because the harness never imports the flake-level bootstrap emitted by `inputs.import-tree`. In the real flake, `/nix/store/*/modules/nixosModules.nix` registers the option; without that module in the harness, only the role definitions remain, and the lookup still throws.
- Replaced the temporary System76-only bootstrap with two structural fixes: (1) `inputs.import-tree` now pipes through a reorder function so `modules/meta/flake-output.nix`, `nixos-helpers.nix`, and the helper stack run before any role touches `flake.*`; (2) `modules/meta/nixos-helpers.nix` imports the upstream `flake-parts/modules/nixosModules.nix` during NixOS evaluation, wiring in the official `mkSubmoduleOptions` schema. After these changes `nix eval --accept-flake-config '.#nixosConfigurations.system76.config.home-manager.users.vx'` no longer throws `error: The option 'flake.nixosModules' does not exist`—the evaluation now proceeds to the expected Home Manager failure (`flake.homeManagerModules.base` missing).
- Added a System76-scoped bootstrap (`modules/system76/flake-nixosModules-bootstrap.nix`) and passed `system76NeedsFlakeBootstrap = true` via the host’s `nixosSystem` `specialArgs`, so only the System76 evaluation defines `options.flake.nixosModules`. This keeps the flake-level `nixosModules` output using the upstream schema while unblocking the host import order. `nix flake check --accept-flake-config` now progresses to the Home Manager failure, and `nix eval --accept-flake-config '.#nixosConfigurations.system76.config.home-manager.users.vx'` reports the same `flake.homeManagerModules.base` error as before—confirming `_module.check` remains enabled and we’re no longer silencing the missing-option check.
- Verifying the new order with
  `nix eval --impure --accept-flake-config --json --expr 'let flake = builtins.getFlake (toString ./.); lib = flake.inputs.nixpkgs.lib; preludeSuffixes = [ "/modules/meta/flake-output.nix" "/modules/meta/nixos-roles-preload.nix" "/modules/meta/nixos-helpers.nix" "/modules/meta/nixos-role-helpers.nix" "/modules/meta/nixos-app-helpers.nix" "/modules/meta/nixos-roles-import.nix" ]; pathOf = value: if builtins.isAttrs value && value ? _file then value._file else if builtins.isPath value then toString value else if builtins.isString value then value else ""; orderedPrelude = paths: builtins.concatLists (map (suffix: builtins.filter (module: lib.hasSuffix suffix (pathOf module)) paths) preludeSuffixes); reorderPaths = paths: let prelude = orderedPrelude paths; preludeKeys = map pathOf prelude; rest = builtins.filter (module: let key = pathOf module; in !(lib.elem key preludeKeys)) paths; in prelude ++ rest; reorderModule = paths: { imports = reorderPaths paths; }; adjusted = (flake.inputs.import-tree.withLib lib).pipeTo reorderModule ./modules; in lib.take 10 (map (x: if builtins.isAttrs x then (x._file or "<lambda>") else x) adjusted.imports)'`
  shows the first six entries now belong to `modules/meta/{flake-output,nixos-roles-preload,nixos-helpers,nixos-role-helpers,nixos-app-helpers,nixos-roles-import}.nix`, confirming the helper prelude executes before any application module.

## Consequence

With `_module.args.inputs` empty, `modules/home-manager/nixos.nix` cannot locate the aggregated Home Manager modules. The default user stanza throws, short‑circuiting option registration, leaving only whichever attributes the System76 overlays append (e.g., `extraAppImports`/`sharedModules`).

## Scratch Reproduction

Evaluating the live module list via `lib.evalModules` shows that injecting `specialArgs = { inputs = flake.inputs; self = flake; }` **alone** does not restore the missing options: both the original evaluation and the instrumented rerun still produce a `config.home-manager` attrset with only `extraAppImports`. This means the attrset is being overwritten (or never populated) later in the module chain, not simply blocked by missing `specialArgs`.

A dedicated scaffold (`debug/system76-home-manager-scaffold.nix`) now recreates the System76 import stack with option stubs and per-module traces. The trace output shows every System76 import (including the “pre-system76” checkpoint) observing only `home-manager = { extraAppImports = … }`, so the attrset is already collapsed before any of the System76 overlays execute. The culprit therefore lies in the shared `flake.nixosModules.base` pipeline.

## Next Investigation Steps

1. Trace exactly where `_module.args.nixosRoleHelpers` is supposed to be injected (the meta helpers module) and confirm whether import-tree skips it or a later module overwrites `_module.args`.
2. Verify the evaluation context around `modules/workstation.nix` once the helpers are present—ensure `resolveRole "base"` pulls in the glue and that `config.home-manager` retains the full attrset.
3. Only after helpers flow, revisit the `home-manager.sharedModules` merge conflict to make sure the overlays still compose cleanly and no new regressions appear.

- 2025-10-22 — Relaxed the guard in `modules/home-manager/nixos.nix` so any `flake.homeManagerModules.base` definition with an `imports` list (even when those entries are lambdas) counts as “real”. Ran `nix eval --accept-flake-config '.#nixosConfigurations.system76.config.home-manager.users.vx'`; it still aborts with `Home Manager base module: expected flake.homeManagerModules.base to be available.`, implying the base module disappears earlier in the System76 sequence rather than being rejected by the guard.
- 2025-10-22 — Replayed the scaffold prefix to isolate where the Home Manager glue disappears. `nix eval --impure --accept-flake-config --json --expr 'let flake = builtins.getFlake (toString ./.) ; lib = flake.inputs.nixpkgs.lib; scaffold = import ./debug/system76-home-manager-scaffold.nix { inherit flake lib; }; prefix = lib.take 4 scaffold.modules; eval = lib.evalModules { modules = prefix; specialArgs = scaffold.specialArgs; }; in eval.config.debug.flakeTrace'` reports `debug.flakeTrace.pre-system76.homeManagerModules = "<empty>"` even though `nixosModules` still lists the full base catalogue, so the namespace is gone before any System76 import runs. Evaluating the scaffold with `[ scaffoldModule, stubModule, firstModule ]` via `nix eval --impure --accept-flake-config --json --expr 'let flake = builtins.getFlake (toString ./.) ; lib = flake.inputs.nixpkgs.lib; scaffold = import ./debug/system76-home-manager-scaffold.nix { inherit flake lib; }; modules = [ scaffold.scaffoldModule scaffold.stubModule scaffold.firstModule ]; eval = lib.evalModules { inherit modules; specialArgs = scaffold.specialArgs; }; in { hm = eval.config.flake.homeManagerModules or {}; nx = builtins.attrNames (eval.config.flake.nixosModules or {}); }'` shows the base keys (`apps`, `base`, `roles`, etc.) are present while `hm` stays `{}`, confirming the collector never hydrates the Home Manager namespace during the meta prelude.
- 2025-10-22 — Attempted Option A fix in `modules/system76/imports.nix`: preferentially pulled `nixosModules`/`homeManagerModules` from `inputs.self` and, when those remained empty, evaluated a bootstrap stack (`flake-nixosModules-bootstrap.nix` + meta collectors) to seed `flake.homeManagerModules`. The new trace still reports `pre-system76` as `<empty>` and `nix eval --accept-flake-config '.#nixosConfigurations.system76.config.home-manager.users.vx'` continues to fail with `Home Manager base module: expected flake.homeManagerModules.base to be available.`, so the fallback injector is not yet feeding the System76 stack.
- 2025-10-22 — Instrumented `modules/system76/imports.nix` to trace every `getModule`/`getRoleModule` call. During the failing eval (`nix eval --accept-flake-config '.#nixosConfigurations.system76.config.home-manager.users.vx'`) each lookup reports Home Manager keys `apps, base, context7Secrets, gui, r2Secrets` still present, even after the role helpers run. The namespace only vanishes after control leaves the System76 aggregator, so the wipe must come from a downstream import (or a later merge) rather than the System76 module itself.
- 2025-10-22 — Added stepwise traces across `modules/system76/imports.nix`; every lookup (`getModule`, `getRoleModule`, etc.) still sees `flake.homeManagerModules` populated (`apps`, `base`, `context7Secrets`, `gui`, `r2Secrets`). After relaxing the Home Manager guard to unwrap `mkOverride` payloads, the evaluation moves past the old missing-base error and now stops at `home-manager.users.vx.apps` being undefined. This confirms the namespace survives the System76 assembly and highlights the next gap is the Home Manager option tree rather than the flake namespace.
- 2025-10-22 — Addressed the "Home Manager base module" guard by unwrapping the collected override. `modules/home-manager/nixos.nix` now expands `flake.homeManagerModules.base.imports` directly (rather than handing the wrapper to Home Manager), which made `nix eval --accept-flake-config '.#nixosConfigurations.system76.config.home-manager.users.vx'` advance to the next failure. The namespace stays intact all the way through System76; the current blocker is that Home Manager lacks option stubs for `home-manager.users.<owner>.apps` and related keys.
