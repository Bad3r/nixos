{
  "jobs":
    {
      "check-compliance":
        {
          "runs-on": "ubuntu-latest",
          "steps":
            [
              {
                "uses": "actions/checkout@v4",
                "with": { "fetch-depth": 0, "submodules": true },
              },
              {
                "name": "Install Nix",
                "uses": "cachix/install-nix-action@v24",
                "with":
                  {
                    "extra_nix_config": "experimental-features = nix-command flakes pipe-operators\nabort-on-warn = true\naccess-tokens = github.com=${{ secrets.GITHUB_TOKEN }}\n",
                    "github_access_token": "${{ secrets.GITHUB_TOKEN }}",
                    "install_url": "https://releases.nixos.org/nix/nix-2.30.2/install",
                  },
              },
              {
                "name": "Prefer HTTPS for GitHub",
                "run": "git config --global url.\"https://github.com/\".insteadOf git@github.com:\ngit config --global url.\"https://github.com/\".insteadOf ssh://git@github.com/",
              },
              {
                "name": "Check flake",
                "run": "nix flake check --extra-experimental-features pipe-operators",
              },
              {
                "name": "Check namespace compliance",
                "run": "./test-dendritic-compliance.sh",
              },
              {
                "name": "Build configurations",
                "run": "nix build .#nixosConfigurations.system76.config.system.build.toplevel \\\n  --dry-run --extra-experimental-features pipe-operators",
              },
              {
                "name": "Generate dependency graph",
                "run": "./generate-dependency-graph.sh",
              },
              {
                "if": "always()",
                "name": "Upload artifacts",
                "uses": "actions/upload-artifact@v4",
                "with":
                  {
                    "name": "dependency-graph",
                    "path": "module-dependencies.dot\nmodule-dependencies.png\nmodule-dependencies.svg\n",
                    "retention-days": 30,
                  },
              },
            ],
        },
      "format-check":
        {
          "runs-on": "ubuntu-latest",
          "steps":
            [
              {
                "uses": "actions/checkout@v4",
                "with": { "fetch-depth": 0, "submodules": true },
              },
              {
                "name": "Install Nix",
                "uses": "cachix/install-nix-action@v24",
                "with":
                  {
                    "extra_nix_config": "experimental-features = nix-command flakes pipe-operators\naccess-tokens = github.com=${{ secrets.GITHUB_TOKEN }}\n",
                    "github_access_token": "${{ secrets.GITHUB_TOKEN }}",
                    "install_url": "https://releases.nixos.org/nix/nix-2.30.2/install",
                  },
              },
              {
                "name": "Check formatting",
                "run": "nix fmt -- --check --extra-experimental-features pipe-operators",
              },
            ],
        },
      "module-validation":
        {
          "runs-on": "ubuntu-latest",
          "steps":
            [
              {
                "uses": "actions/checkout@v4",
                "with": { "fetch-depth": 0, "submodules": true },
              },
              {
                "name": "Install Nix",
                "uses": "cachix/install-nix-action@v24",
                "with":
                  {
                    "extra_nix_config": "experimental-features = nix-command flakes pipe-operators\naccess-tokens = github.com=${{ secrets.GITHUB_TOKEN }}\n",
                    "github_access_token": "${{ secrets.GITHUB_TOKEN }}",
                    "install_url": "https://releases.nixos.org/nix/nix-2.30.2/install",
                  },
              },
              {
                "name": "Validate namespaces",
                "run": "# Check that no modules create wrong namespaces\n! grep -r \"flake.modules.nixos.desktop\" modules/ --include=\"*.nix\"\\n! grep -r \"flake.modules.nixos.audio\" modules/ --include=\"*.nix\"\\n! grep -r \"flake.modules.nixos.boot\" modules/ --include=\"*.nix\"\\n! grep -r \"flake.modules.nixos.storage\" modules/ --include=\"*.nix\"",
              },
              {
                "name": "Check import-tree usage",
                "run": 'grep -q "import-tree.*modules" flake.nix || exit 1',
              },
              {
                "name": "Check no literal imports",
                "run": "! grep -r \"imports.*\\./\" modules/ --include=\"*.nix\" || exit 1",
              },
            ],
        },
    },
  "name": "Dendritic Pattern Compliance Check",
  "on":
    {
      "pull_request": { "branches": ["main", "master"] },
      "push": { "branches": ["main", "master"] },
    },
}
