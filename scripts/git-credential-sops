#!/usr/bin/env bash
# git-credential-sops: A Git credential helper that emits credentials at runtime
# from a SOPS-managed secret file. Configure per URL, e.g.:
#   git config --global credential.useHttpPath true
#   git config --global 'credential.https://github.com.helper' '!./scripts/git-credential-sops'
# Requires: SOPS_GIT_TOKEN_PATH points to a file containing the token (readable by the user).

set -euo pipefail

protocol="" host="" path="" username=""
while IFS= read -r line; do
  case "$line" in
    protocol=*) protocol="${line#protocol=}" ;;
    host=*) host="${line#host=}" ;;
    path=*) path="${line#path=}" ;;
    username=*) username="${line#username=}" ;;
  esac
done

if [ -z "${SOPS_GIT_TOKEN_PATH:-}" ]; then
  echo "git-credential-sops: SOPS_GIT_TOKEN_PATH is not set" >&2
  exit 1
fi

if [ ! -r "$SOPS_GIT_TOKEN_PATH" ]; then
  echo "git-credential-sops: cannot read token file: $SOPS_GIT_TOKEN_PATH" >&2
  exit 1
fi

# Output credentials for Git
printf 'username=%s\n' "oauth2"
printf 'password=%s\n' "$(cat "$SOPS_GIT_TOKEN_PATH")"
