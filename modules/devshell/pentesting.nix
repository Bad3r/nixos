{ inputs, lib, ... }:
let
  # Single source of truth for pentesting tools
  # Both the devshell and Home Manager module derive from this list
  #
  # Entry types:
  #   - Normal: adds package to devshell AND creates wrapper
  #   - devshellOnly: adds package to devshell only (no wrapper)
  #   - wrapperOnly: creates wrapper only (no package, uses command from another entry's package)
  toolDefs = [
    {
      name = "burpsuite";
      # Command matches the alias name; alias internally calls burpsuitepro
      desktop = {
        desktopName = "BurpSuite Professional (Pentesting Shell)";
        comment = "An integrated platform for performing security testing of web applications";
        categories = [
          "Development"
          "Security"
          "System"
        ];
        # icon handled specially in HM module (needs inputs access)
      };
    }
    {
      # Wrapper for loader command; package provided by burpsuitepro entry
      name = "burpsuite-loader";
      command = "loader";
      package = "burpsuitepro";
      wrapperOnly = true;
    }
    {
      # Raw burpsuitepro package for direct access (burpsuitepro, loader commands)
      name = "burpsuitepro";
      devshellOnly = true;
    }
    {
      name = "wireshark";
      desktop = {
        desktopName = "Wireshark (Pentesting Shell)";
        comment = "Inspect traffic using Wireshark via the pentesting dev shell";
        categories = [
          "Network"
          "Security"
          "Utility"
        ];
        icon = "wireshark";
      };
    }
    {
      name = "charles";
      desktop = {
        desktopName = "Charles Proxy (Pentesting Shell)";
        comment = "Debug HTTP(S) traffic using Charles via the pentesting dev shell";
        categories = [
          "Network"
          "Security"
          "Utility"
        ];
        # Use freedesktop icon name (charles icon unavailable without building package)
        icon = "network-server";
      };
    }
    { name = "nmap"; }
    { name = "aircrack-ng"; }
    # hydra disabled: https://github.com/NixOS/nixpkgs/issues/476278
    { name = "john"; }
    { name = "sqlmap"; }
    { name = "metasploit"; }
    {
      # Raw metasploit package for msfconsole, msfvenom, etc.
      name = "metasploit-framework";
      devshellOnly = true;
    }
    {
      # Direct msfconsole access; package provided by metasploit-framework
      name = "msfconsole";
      package = "metasploit-framework";
      wrapperOnly = true;
    }
    { name = "hashcat"; }
    { name = "wappalyzer"; }
    # TODO: re-enable when upstream is fixed https://github.com/Bad3r/nixos/issues/44
    # ghidra disabled: https://github.com/NixOS/nixpkgs/issues/478986
    # {
    #   name = "ghidra";
    #   desktop = {
    #     desktopName = "Ghidra (Pentesting Shell)";
    #     comment = "Software reverse engineering framework";
    #     categories = [
    #       "Development"
    #       "Security"
    #     ];
    #     icon = "ghidra";
    #   };
    # }
    {
      name = "cutter";
      desktop = {
        desktopName = "Cutter (Pentesting Shell)";
        comment = "Reverse engineering platform powered by rizin";
        categories = [
          "Development"
          "Security"
        ];
        icon = "cutter";
      };
    }
    {
      name = "iaito";
      desktop = {
        desktopName = "Iaito (Pentesting Shell)";
        comment = "Official graphical interface for radare2";
        categories = [
          "Development"
          "Security"
        ];
        icon = "iaito";
      };
    }
    { name = "radare2"; }
    { name = "rizin"; }
    { name = "mitmproxy"; }
    { name = "whatweb"; }
    # malimite disabled: depends on ghidra (https://github.com/Bad3r/nixos/issues/44)
    # {
    #   name = "malimite";
    #   desktop = {
    #     desktopName = "Malimite (Pentesting Shell)";
    #     comment = "iOS and macOS binary analysis tool";
    #     categories = [
    #       "Development"
    #       "Security"
    #     ];
    #     icon = "malimite";
    #   };
    # }
  ];

  # Tools that contribute packages to the devshell
  devshellTools = lib.filter (t: !(t.wrapperOnly or false)) toolDefs;

  # Tools that get wrappers in Home Manager
  wrapperTools = lib.filter (t: !(t.devshellOnly or false)) toolDefs;

  # Generate tool names string for shellHook
  toolNamesStr = lib.concatMapStringsSep ", " (t: t.name) toolDefs;
in
{
  nixpkgs.allowedUnfreePackages = lib.mkAfter [ "charles" ];

  # Devshell with all pentesting packages
  perSystem =
    { pkgs, ... }:
    let
      burpsuitePackages = inputs."burpsuite-pro-flake".packages;
      inherit (burpsuitePackages.${pkgs.stdenv.hostPlatform.system}) burpsuitepro;
      inherit (pkgs) charles;

      burpsuiteAlias = pkgs.writeShellApplication {
        name = "burpsuite";
        runtimeInputs = [
          burpsuitepro
          pkgs.coreutils
        ];
        text = /* bash */ ''
          exec ${burpsuitepro}/bin/burpsuitepro "$@"
        '';
      };

      metasploitAlias = pkgs.writeShellApplication {
        name = "metasploit";
        runtimeInputs = [
          pkgs.coreutils
          pkgs.metasploit
        ];
        text = /* bash */ ''
          exec ${pkgs.metasploit}/bin/msfconsole "$@"
        '';
      };

      wappalyzerNext = pkgs.callPackage ../../packages/wappalyzer-next { };

      # Map tool names to their packages (only for tools that contribute packages)
      toolPackageMap = {
        burpsuite = burpsuiteAlias;
        inherit burpsuitepro;
        inherit (pkgs)
          wireshark
          nmap
          aircrack-ng
          john
          sqlmap
          hashcat
          # ghidra disabled: https://github.com/Bad3r/nixos/issues/44
          cutter
          iaito
          radare2
          rizin
          mitmproxy
          whatweb
          ;
        # malimite disabled: https://github.com/Bad3r/nixos/issues/44
        inherit charles;
        metasploit = metasploitAlias;
        metasploit-framework = pkgs.metasploit;
        wappalyzer = wappalyzerNext;
      };

      # Build package list from devshell tools only (excludes wrapperOnly entries)
      pentestPackages = map (t: toolPackageMap.${t.name}) devshellTools;
    in
    {
      # Export individual tool packages for on-demand loading via wrappers
      # e.g., nix shell .#pentest-burpsuite only builds burpsuite, not the full devshell
      packages = lib.listToAttrs (
        map (t: {
          name = "pentest-${t.name}";
          value = toolPackageMap.${t.name};
        }) devshellTools
      );
      make-shells.pentesting = {
        packages = pentestPackages;
        shellHook = ''
          echo "Pentesting shell ready. Tools: ${toolNamesStr}."
          echo "Tip: ensure your user is in the 'wireshark' group to capture packets."
        '';
      };
    };

  # Home Manager module: wrappers and desktop entries for lazy-loaded access
  flake.homeManagerModules.apps."pentesting-devshell" =
    {
      lib,
      pkgs,
      inputs,
      ...
    }:
    let
      rootPath = inputs.self.outPath;
      nixBin = lib.getExe' pkgs.nix "nix";

      # Access icon directly from flake input source (no package build required)
      burpsuiteIcon = "${inputs."burpsuite-pro-flake"}/assets/icons/hicolor/256x256/apps/burpsuitepro.png";

      mkWrapper =
        tool:
        let
          inherit (tool) name;
          command = tool.command or name;
          # For wrapperOnly tools, use specified package; otherwise use own name
          packageName = tool.package or name;
        in
        pkgs.writeShellApplication {
          name = "pentest-${name}";
          runtimeInputs = [
            pkgs.nix
            pkgs.coreutils
          ];
          # Use nix shell with specific package for on-demand loading
          # This only builds the requested tool, not the entire devshell
          text = /* bash */ ''
            exec ${nixBin} shell ${lib.escapeShellArg rootPath}#pentest-${lib.escapeShellArg packageName} --accept-flake-config --command ${lib.escapeShellArg command} "$@"
          '';
        };

      wrappers = map mkWrapper wrapperTools;

      mkDesktopEntry =
        tool:
        let
          inherit (tool) name desktop;
          # Handle burpsuite icon specially (requires inputs access)
          icon = if name == "burpsuite" then burpsuiteIcon else desktop.icon or null;
        in
        {
          inherit name;
          value = {
            inherit (desktop) comment categories;
            exec = "pentest-${name}";
            terminal = false;
            name = desktop.desktopName;
          }
          // lib.optionalAttrs (icon != null) { inherit icon; };
        };

      desktopEntries = builtins.listToAttrs (
        map mkDesktopEntry (lib.filter (tool: tool ? desktop) wrapperTools)
      );
    in
    {
      home.packages = lib.mkAfter wrappers;
      xdg.enable = lib.mkDefault true;
      xdg.desktopEntries = desktopEntries;
    };
}
