{
  nixpkgs.allowedUnfreePackages = [ "charles" ];

  flake.homeManagerModules.apps."pentesting-devshell" =
    {
      lib,
      pkgs,
      inputs,
      ...
    }:
    let
      rootPath = builtins.toString ../..;
      nixBin = lib.getExe' pkgs.nix "nix";
      # Access icons directly from flake input source (no package build required)
      burpsuiteIcon = "${inputs."burpsuite-pro-flake"}/assets/icons/hicolor/256x256/apps/burpsuitepro.png";
      pentestTools = [
        {
          wrapper = "burpsuite";
          command = "burpsuitepro";
          desktop = {
            desktopName = "BurpSuite Professional (Pentesting Shell)";
            comment = "An integrated platform for performing security testing of web applications";
            categories = [
              "Development"
              "Security"
              "System"
            ];
            icon = burpsuiteIcon;
          };
        }
        {
          wrapper = "burpsuite-loader";
          command = "loader";
        }
        {
          wrapper = "wireshark";
          desktop = {
            desktopName = "Wireshark (Pentesting Shell)";
            comment = "Inspect traffic using Wireshark via the pentesting dev shell";
            categories = [
              "Network"
              "Security"
              "Utility"
            ];
            icon = "wireshark";
          };
        }
        {
          wrapper = "charles";
          desktop = {
            desktopName = "Charles Proxy (Pentesting Shell)";
            comment = "Debug HTTP(S) traffic using Charles via the pentesting dev shell";
            categories = [
              "Network"
              "Security"
              "Utility"
            ];
            # Use freedesktop icon name (charles icon unavailable without building package)
            icon = "network-server";
          };
        }
        { wrapper = "nmap"; }
        { wrapper = "aircrack-ng"; }
        { wrapper = "hydra"; }
        { wrapper = "john"; }
        { wrapper = "sqlmap"; }
        { wrapper = "metasploit"; }
        { wrapper = "hashcat"; }
        { wrapper = "wappalyzer"; }
      ];
      mkWrapper =
        tool:
        let
          name = tool.wrapper or tool;
          command = tool.command or name;
        in
        pkgs.writeShellApplication {
          name = "pentest-${name}";
          runtimeInputs = [
            pkgs.nix
            pkgs.coreutils
          ];
          text = ''
            exec ${nixBin} develop ${lib.escapeShellArg rootPath}#pentesting --accept-flake-config --command ${lib.escapeShellArg command} "$@"
          '';
        };
      wrappers = map mkWrapper pentestTools;
      mkDesktopEntry =
        tool:
        let
          name = tool.wrapper;
          inherit (tool) desktop;
          includeIcon = desktop ? icon;
        in
        {
          inherit name;
          value = {
            inherit (desktop) comment categories;
            exec = "pentest-${name}";
            terminal = false;
            name = desktop.desktopName;
          }
          // lib.optionalAttrs includeIcon { inherit (desktop) icon; };
        };
      desktopEntries = builtins.listToAttrs (
        map mkDesktopEntry (lib.filter (tool: tool ? desktop) pentestTools)
      );
    in
    {
      home.packages = lib.mkAfter wrappers;
      xdg.enable = lib.mkDefault true;
      xdg.desktopEntries = desktopEntries;
    };
}
